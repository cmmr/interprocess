<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Shared and Exclusive Locks — mutex • interprocess</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Noto_Sans-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Shared and Exclusive Locks — mutex"><meta name="description" content="Mutually exclusive (mutex) locks are used to control access to shared
resources.
An exclusive lock grants permission to one process at a time, for
example to update the contents of a database file. While an exclusive lock
is active, no other exclusive or shared locks will be granted.
Multiple shared locks can be held by different processes at the same
time, for example to read a database file. While a shared lock is active, no
exclusive locks will be granted."><meta property="og:description" content="Mutually exclusive (mutex) locks are used to control access to shared
resources.
An exclusive lock grants permission to one process at a time, for
example to update the contents of a database file. While an exclusive lock
is active, no other exclusive or shared locks will be granted.
Multiple shared locks can be held by different processes at the same
time, for example to read a database file. While a shared lock is active, no
exclusive locks will be granted."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">interprocess</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmmr/interprocess/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Shared and Exclusive Locks</h1>
      <small class="dont-index">Source: <a href="https://github.com/cmmr/interprocess/blob/master/R/mutex.r" class="external-link"><code>R/mutex.r</code></a></small>
      <div class="d-none name"><code>mutex.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Mutually exclusive (mutex) locks are used to control access to shared
resources.<br><br>
An <em>exclusive lock</em> grants permission to one process at a time, for
example to update the contents of a database file. While an exclusive lock
is active, no other exclusive or shared locks will be granted.<br><br>
Multiple <em>shared locks</em> can be held by different processes at the same
time, for example to read a database file. While a shared lock is active, no
exclusive locks will be granted.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mutex</span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="uid.html">uid</a></span><span class="op">(</span><span class="op">)</span>, assert <span class="op">=</span> <span class="cn">NULL</span>, cleanup <span class="op">=</span> <span class="cn">FALSE</span>, file <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'mutex'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">expr</span>, alt_expr <span class="op">=</span> <span class="cn">NULL</span>, shared <span class="op">=</span> <span class="cn">FALSE</span>, timeout_ms <span class="op">=</span> <span class="cn">Inf</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-name">name<a class="anchor" aria-label="anchor" href="#arg-name"></a></dt>
<dd><p>Unique ID. Alphanumeric, starting with a letter.</p></dd>


<dt id="arg-assert">assert<a class="anchor" aria-label="anchor" href="#arg-assert"></a></dt>
<dd><p>Apply an additional constraint.</p><ul><li><p><code>'create'</code> - Error if the mutex <em>already exists</em>.</p></li>
<li><p><code>'exists'</code> - Error if the mutex <em>doesn't exist</em>.</p></li>
<li><p><code>NULL</code> - No constraint; create the mutex if it doesn't exist.</p></li>
</ul></dd>


<dt id="arg-cleanup">cleanup<a class="anchor" aria-label="anchor" href="#arg-cleanup"></a></dt>
<dd><p>Remove the mutex when the R session exits. If <code>FALSE</code>,
the mutex will persist until <code>$remove()</code> is called or the operating
system is restarted.</p></dd>


<dt id="arg-file">file<a class="anchor" aria-label="anchor" href="#arg-file"></a></dt>
<dd><p>Use a hash of this file/directory path as the mutex name. The
file itself will not be read or modified, and does not need to exist.</p></dd>


<dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>A <code>mutex</code> object.</p></dd>


<dt id="arg-expr">expr<a class="anchor" aria-label="anchor" href="#arg-expr"></a></dt>
<dd><p>Expression to evaluate if the mutex is acquired.</p></dd>


<dt id="arg-alt-expr">alt_expr<a class="anchor" aria-label="anchor" href="#arg-alt-expr"></a></dt>
<dd><p>Expression to evaluate if <code>timeout_ms</code> is reached.</p></dd>


<dt id="arg-shared">shared<a class="anchor" aria-label="anchor" href="#arg-shared"></a></dt>
<dd><p>If <code>FALSE</code> (the default) an exclusive lock is returned.
If <code>TRUE</code>, a shared lock is returned instead. See description.</p></dd>


<dt id="arg-timeout-ms">timeout_ms<a class="anchor" aria-label="anchor" href="#arg-timeout-ms"></a></dt>
<dd><p>Maximum time (in milliseconds) to block the process
while waiting for the operation to succeed. Use <code>0</code> or <code>Inf</code> to
return immediately or only when successful, respectively.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Not used.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p><code>mutex()</code> returns a <code>mutex</code> object with the following methods:</p><ul><li><p><code>$name</code></p><ul><li><p>Returns the mutex's name (scalar character).</p></li>
</ul></li>
<li><p><code>$lock(shared = FALSE, timeout_ms = Inf)</code></p><ul><li><p>Returns <code>TRUE</code> if the lock is acquired, or <code>FALSE</code> if the timeout is reached.</p></li>
</ul></li>
<li><p><code>$unlock(warn = TRUE)</code></p><ul><li><p>Returns <code>TRUE</code> if successful, or <code>FALSE</code> (with optional warning) if the mutex wasn't locked.</p></li>
</ul></li>
<li><p><code>$remove()</code></p><ul><li><p>Returns <code>TRUE</code> on success, or <code>FALSE</code> if the mutex wasn't found.<br><br></p></li>
</ul></li>
</ul><p><code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> returns <code>eval(expr)</code> if the lock was acquired, or <code>eval(alt_expr)</code> if the timeout is reached.</p>
    </div>
    <div class="section level2">
    <h2 id="error-handling">Error Handling<a class="anchor" aria-label="anchor" href="#error-handling"></a></h2>



<p>The <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> wrapper automatically unlocks the mutex if an error stops
evaluation of <code>expr</code>. If you are directly calling <code>lock()</code>, be sure that
<code>unlock()</code> is registered with error handlers or added to <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>.
Otherwise, the lock will persist until the process terminates.</p>
    </div>
    <div class="section level2">
    <h2 id="duplicate-mutexes">Duplicate Mutexes<a class="anchor" aria-label="anchor" href="#duplicate-mutexes"></a></h2>



<p>Mutex locks are per-process. If a process already has a lock, it can not
attempt to acquire a second lock on the same mutex.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mut</span> <span class="op">&lt;-</span> <span class="fu">interprocess</span><span class="fu">::</span><span class="fu">mutex</span><span class="op">(</span>file <span class="op">=</span> <span class="va">tmp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mut</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;mutex&gt; "ZkUDOefmercs"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Exclusive lock to write the file</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mut</span>, <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="st">'some data'</span>, <span class="va">tmp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use a shared lock to read the file</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mut</span>,</span></span>
<span class="r-in"><span>  shared     <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  timeout_ms <span class="op">=</span> <span class="fl">0</span>, </span></span>
<span class="r-in"><span>  expr       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>  alt_expr   <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">'Mutex was locked. Giving up.'</span><span class="op">)</span> <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "some data"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Directly lock/unlock with safeguards</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="va">mut</span><span class="op">$</span><span class="fu">lock</span><span class="op">(</span>timeout_ms <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="va">mut</span><span class="op">$</span><span class="fu">unlock</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="st">'more data'</span>, <span class="va">tmp</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">'Mutex was locked. Giving up.'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mut</span><span class="op">$</span><span class="fu">remove</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel P. Smith, Alkek Center for Metagenomics and Microbiome Research.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer></div>





  </body></html>

